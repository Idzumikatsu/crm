# Schedule Tracker

## Настройка окружения

1. **Java 21**
   - Установите JDK 21. На Linux можно установить пакет `openjdk-21-jdk`.
2. **Maven**
   - Используйте Maven 3.9.9 или запускайте через прилагаемый скрипт `./mvnw`.
3. **PostgreSQL**
   - Приложение ожидает базу `schedule` с пользователем `postgres` и паролем `postgres`.
   - Быстрый вариант через Docker:
     ```bash
     docker run --name schedule-db -p 5432:5432 -e POSTGRES_DB=schedule \
       -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -d postgres:15
     ```
   - В `application.yml` адрес БД задаётся через переменную окружения `DB_HOST`.
     По умолчанию используется `localhost`. Если профиль `postgres` не активирован,
     используется встроенная база H2.
4. **Сборка и запуск**
   - Сборка: `./mvnw package`
   - Запуск: `./mvnw spring-boot:run`
   - Для упрощения можно использовать скрипт `./start.sh`, который
     автоматически вызывает Maven Wrapper и запускает приложение.
   - Приложение слушает порт `8080`. Убедитесь, что этот порт свободен
     перед запуском, иначе старт завершится ошибкой.
   - При первом запуске Maven скачает зависимости из Maven Central.
     Требуется подключение к интернету или локальный кеш артефактов.
   - В проект подключен модуль `spring-boot-starter-validation`,
     поэтому запросы валидируются через Bean Validation.
5. **Запуск тестов**
   - Выполните `./mvnw test`.

6. **Прокси**
   - Для получения зависимостей может потребоваться сетевой прокси.
     Укажите его хост и порт в переменных окружения
     `PROXY_HOST` и `PROXY_PORT` (а также `HTTP_PROXY` и `HTTPS_PROXY`
     вида `http://<host>:<port>`), чтобы Maven и Git могли
     подключаться к удалённым репозиториям. Если переменные не заданы,
     прокси не используется.
  - Для автоматического создания настроек воспользуйтесь скриптом
    `scripts/setup-proxy.sh`. Он создаёт `.mvn/settings.xml` только при
    наличии переменных окружения `PROXY_HOST` и `PROXY_PORT`, иначе
    генерирует пустой файл и прокси не используется. Скрипт также
    настраивает git при наличии `HTTP_PROXY`/`HTTPS_PROXY`.
   - Файл `.mvn/jvm.config` по умолчанию пуст, поэтому параметры
     прокси передаются только через переменные окружения.
   - Если проект собирается через GitHub Actions, эти значения
     необходимо задать как секреты репозитория `PROXY_HOST` и
     `PROXY_PORT`.

## Запуск в Docker

Приложение использует профиль `postgres`, поэтому его нужно активировать
через переменную `SPRING_PROFILES_ACTIVE`. Также контейнеру требуется адрес
сервиса PostgreSQL в переменной `DB_HOST`. Если вы создавали контейнер БД по
примеру выше, его имя `schedule-db`. Для связи контейнеров понадобится сеть
`app-network`; создайте её при необходимости командой `docker network create
app-network`. Запуск приложения выглядит так:

```bash
docker run --rm -it --network app-network \
  -e DB_HOST=schedule-db \
  -e SPRING_PROFILES_ACTIVE=postgres \
  --name my-java-app my-java-app
```

Для удобства можно воспользоваться `docker-compose.yml`, который поднимет
PostgreSQL, само приложение и Nginx в роли обратного прокси. Перед запуском
убедитесь, что в корне проекта есть `app.jar`:

```bash
./mvnw package
cp target/*.jar app.jar
docker compose up --build
```

### Проверка сервиса
После деплоя убедитесь, что контейнеры запущены:
```bash
docker compose ps -a
```
Если сервис `app` отсутствует или имеет статус `Exited`, убедитесь,
что перед сборкой был создан `app.jar`, и просмотрите лог:
```bash
docker compose logs app
```
Частая причина ошибки 502/503 — приложение не смогло подключиться к базе. Запустите контейнеры повторно:
```bash
docker compose up -d
```



## Учетные записи

После первого запуска создаются учетные записи менеджера и преподавателя.
Параметры входа:
- менеджер: `manager`/`manager`
- преподаватель: `teacher`/`teacher`

Новые пользователи могут зарегистрироваться через POST `/api/auth/register`,
передав `username`, `password` и опциональное `role` в теле запроса.

## Веб-интерфейс

Основные страницы располагаются в каталоге `src/main/resources/static` и доступны
без авторизации:
- `/login` или `/login.html` – форма входа в систему;
- `/index.html` – стартовая страница после логина;
- `/manager.html` и `/teacher.html` – кабинеты менеджера и преподавателя.
- `/teachers.html` и `/students.html` – простые страницы для управления
  списками преподавателей и студентов.
Для использования Thymeleaf эти же файлы продублированы в `src/main/resources/templates`.
Страницы обращаются к REST API через fetch-запросы.

### Карта сайта

- `http://localhost/login.html` – вход в систему
- `http://localhost/index.html` – стартовая страница после логина
- `http://localhost/manager.html` – кабинет менеджера
- `http://localhost/teacher.html` – кабинет преподавателя
- `http://localhost/teachers.html` – управление преподавателями
- `http://localhost/students.html` – управление студентами

### REST API
Основные эндпоинты:
- `POST /api/auth/login` и `POST /api/auth/register`
- CRUD для преподавателей `/api/teachers`
- CRUD для студентов `/api/students`
- CRUD для групп `/api/groups`
- Управление слотами преподавателей `/api/time-slots`
- Работа с занятиями `/api/lessons` (проверяется наличие слота преподавателя и отсутствие пересечений)
- Получение данных пользователя `/api/users`


## API документация

После запуска приложения документация Swagger доступна по адресу
`/swagger-ui.html`. Там перечислены все доступные REST эндпоинты.

## CI/CD

Репозиторий содержит workflow `.github/workflows/deploy.yml`, который автоматически деплоит приложение на выделенный VPS при пуше в ветку `main`. Для корректной работы необходимо создать следующие секреты репозитория:

- `VPS_HOST` – адрес сервера;
- `VPS_USER` – имя пользователя для подключения;
- `VPS_PASSWORD` – пароль пользователя;
- `VPS_PORT` – HTTP‑порт приложения (например, `80`);
- `VPS_SSH_PORT` – SSH‑порт, если отличается от `22`.

Workflow собирает JAR, копирует его и файлы инфраструктуры на сервер и запускает `docker compose up -d`.
Сервер должен иметь установленный Docker версии **27.5.1** или новее (API 1.47), так как деплой тестировался на этой версии.




