# Requires secrets:
#   VPS_HOST, VPS_USER, VPS_SSH_KEY, VPS_PASSPHRASE
#   (optional) VPS_PORT – если используется нестандартный SSH-порт

name: Deploy to VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Клонируем репозиторий
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Устанавливаем Temurin JDK 21
    - name: Setup Temurin JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 21

    # 3. Собираем JAR без тестов
    - name: Build JAR
      run: mvn -B clean package -Dmaven.test.skip=true

    # 4. Переименовываем артефакт → app.jar (проще COPY в Dockerfile)
    - name: Prepare artifact
      run: cp target/*.jar target/app.jar

    # 5. Копируем инфраструктурные файлы (Dockerfile, compose-файл) на VPS
    - name: Copy infra files to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host:       ${{ secrets.VPS_HOST }}
        username:   ${{ secrets.VPS_USER }}
        key:        ${{ secrets.VPS_SSH_KEY }}
        passphrase: ${{ secrets.VPS_PASSPHRASE }}
        # port:     ${{ secrets.VPS_PORT }}   # раскомментируйте, если не 22
        source: |
          Dockerfile
          docker-compose.yml
        target: /root/myapp
        rm: true

    # 6. Копируем собранный JAR на VPS
    - name: Copy app.jar to VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host:       ${{ secrets.VPS_HOST }}
        username:   ${{ secrets.VPS_USER }}
        key:        ${{ secrets.VPS_SSH_KEY }}
        passphrase: ${{ secrets.VPS_PASSPHRASE }}
        # port:     ${{ secrets.VPS_PORT }}   # раскомментируйте, если не 22
        source:  target/app.jar
        target:  /root/myapp/app.jar
        rm:      true

    # 7. Пересобираем образ и перезапускаем контейнер
    - name: Docker Compose up
      uses: appleboy/ssh-action@v1.0.0
      with:
        host:       ${{ secrets.VPS_HOST }}
        username:   ${{ secrets.VPS_USER }}
        key:        ${{ secrets.VPS_SSH_KEY }}
        passphrase: ${{ secrets.VPS_PASSPHRASE }}
        # port:     ${{ secrets.VPS_PORT }}   # раскомментируйте, если не 22
        script: |
          set -e
          cd /root/myapp
          docker compose build --no-cache
          docker compose up -d
