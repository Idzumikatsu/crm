name: Build and Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      http_proxy: http://proxy:8080
      https_proxy: http://proxy:8080
      HTTP_PROXY: http://proxy:8080
      HTTPS_PROXY: http://proxy:8080

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Configure git proxy
        run: |
          git config --global http.proxy $http_proxy
          git config --global https.proxy $https_proxy

      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

      - name: Prepare SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_PRIVATE_KEY" > key.pem
          chmod 600 key.pem

      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 95.164.2.48 >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
        run: |
          scp -i key.pem target/scheduletracker-0.0.1-SNAPSHOT.jar Dockerfile root@95.164.2.48:/proj/
          ssh -i key.pem root@95.164.2.48 << EOF
            docker stop my-java-app || true
            docker rm my-java-app  || true
            docker build -t my-java-app /proj/
            docker run -d -p 8080:8080 --network app-network -e DB_HOST=${DB_HOST:-schedule-db} --name my-java-app my-java-app
          EOF
