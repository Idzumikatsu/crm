Декомпозиция плана работ с NGINX для Codex до атомарных задач
(каждый пункт — минимально-самостоятельная единица, которую можно назначить человеку или включить в тикет трекера)

1. Сбор требований и аудит
1.1. Назначить ответственного за фазу аудита.
1.2. Запросить у команды бекэнда список всех публичных и внутренних эндпоинтов.
1.3. Зафиксировать метод + URI + протокол (HTTP/WS/GRPC) для каждого эндпоинта в таблице.
1.4. Получить статистику RPS за последний месяц из APM/логов.
1.5. Выписать SLA по latency и аптайму из SRE-документа.
1.6. Проверить регуляторные требования (GDPR, персональные данные, логи).
1.7. Определить, где сейчас происходит SSL-терминация.
1.8. Согласовать, какие функции перейдут в NGINX (SSL, кеш, rate-limit).
1.9. Зафиксировать результаты в конфлюэнс-странице «NGINX Requirements».

2. Проектирование топологии
2.1. Нарисовать схему текущих сетевых потоков (draw.io).
2.2. Согласовать, будет ли NGINX sidecar, DaemonSet или выделенный слой.
2.3. Выбрать тип балансировки: round-robin / least_conn / weight.
2.4. Проверить поддержку HTTP/2 клиентами (---> список User-Agent).
2.5. Решить, запускать ли HTTP/3 (фича-флаг).
2.6. Описать стратегию blue-green деплоя NGINX (пошаговый план).
2.7. Создать диаграмму целевой топологии и приложить к дизайн-доку.

3. Производительность
3.1. Замерить среднее и пиковое число CPU на узлах, где будет NGINX.
3.2. Рассчитать требуемое worker_processes (= кол-ву vCPU).
3.3. Выполнить нагрузочный тест на статическом контенте (wrk).
3.4. Подобрать значения worker_connections, чтобы не упереться в ulimit -n.
3.5. Зафиксировать политику keep-alive (timeout и кол-во коннектов).
3.6. Проанализировать, какие MIME-типы надо исключать из gzip/brotli.
3.7. Определить целевые тайм-ауты (proxy_connect/read/send), исходя из p99 latency JVM.
3.8. Подготовить документ «Performance Baselines».

4. Безопасность
4.1. Проверить актуальность TLS-сертификатов (дата, цепочка).
4.2. Сгенерировать список поддерживаемых TLS-версий и шифров.
4.3. Запустить testssl.sh на staging-домене.
4.4. Сформировать HSTS параметры (макс-возраст, preload).
4.5. Настроить OCSP Stapling в тестовой среде и проверить openssl -status.
4.6. Выписать лимиты для rate-limit (r/s) на основе логов.
4.7. Составить правила WAF для типовых атак (OWASP Top-10).
4.8. Определить максимальный размер тела запроса для разных роутов (API, upload).
4.9. Создать чек-лист «Security Gate» для pull-request'а конфигурации.

5. Кеширование и статика
5.1. Каталогизировать статические пути (/assets, /images, и т.д.).
5.2. Проверить, есть ли hash-имена файлов в фронтенд-бандле.
5.3. Назначить TTL и директиву immutable для versioned ассетов.
5.4. Решить, какие API-методы допускают micro-cache (< 1 мин).
5.5. Расчитать размер кэша и свободное место на диске.
5.6. Прописать стратегию purge при деплое (hook в CI/CD).

6. Real-time / WebSocket
6.1. Составить список WS/SSE эндпоинтов.
6.2. Проверить поддержку Upgrade у бекенда.
6.3. Выделить отдельный upstream-блок для долгих коннектов.
6.4. Задать специфичные тайм-ауты (proxy_read_timeout > 5 мин).
6.5. Провести тест разрыва соединения и повторного подключения.

7. Наблюдаемость
7.1. Определить формат JSON-логов (ключи, порядок).
7.2. Настроить rSyslog или Filebeat для отправки логов в ELK.
7.3. Поднять stub_status и проверить, что метрики собираются в Prometheus.
7.4. Включить nginx-prometheus-exporter как sidecar.
7.5. Составить 4 ключевых алерта (5xx rate, high latency, открытые файлы, upstream failures).
7.6. Добавить дашборд Grafana с темплейтами.
7.7. Документировать «How to troubleshoot 502».

8. Высокая доступность
8.1. Рассчитать нужное количество инстансов NGINX для 2× отказоустойчивости.
8.2. Настроить frontend L4/L7 LB (Cloud LB или MetalLB).
8.3. Конфигурировать max_fails и fail_timeout в upstream.
8.4. Тестировать slow-start после рестарта бэкенда.
8.5. Отработать nginx -s reload под нагрузкой и убедиться во время graceful shutdown.
8.6. Составить DR-план (шаги, RTO, RPO).
8.7. Организовать ежеквартальную репетицию DR-плана.

9. CI/CD и IaC
9.1. Создать репозиторий codex-nginx-config.
9.2. Настроить pre-commit hook с nginx -t.
9.3. Добавить security-lint (sslscan, yamllint).
9.4. Шаблонизировать конфиги через Helm chart.
9.5. Добавить шаг canary-деплоя (10 % трафика, 5 мин).
9.6. Реализовать автоматический rollback при росте 5xx > 1 %.
9.7. Документировать процесс выпуска в README.

10. Документация и обучение
10.1. Создать раздел «NGINX» в вики проекта Codex.
10.2. Написать runbook с типовыми инцидентами (502, 504, TLS error).
10.3. Подготовить презентацию «NGINX basics for developers».
10.4. Провести воркшоп:
  • как читать access-лог;
  • как временно включать debug-лог;
  • как проверять конфиг локально в Docker.
10.5. Сформировать чек-лист pre-prod (TLS, headers, limits, metrics).
10.6. Назначить ответственных за актуализацию документации раз в квартал.
